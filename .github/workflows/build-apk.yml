name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install dependencies
      run: npm install --legacy-peer-deps
      
    - name: Build web assets
      run: npm run build
      
    - name: Sync Capacitor
      run: npx cap sync android
      
    - name: Make gradlew executable
      run: chmod +x android/gradlew
      
    - name: Build APK (Debug)
      working-directory: android
      run: ./gradlew assembleDebug
      
    - name: Build APK (Release)
      working-directory: android
      run: ./gradlew assembleRelease
      
    - name: Rename APKs for distribution
      run: |
        mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/Os-Sete-Livramentos-debug.apk
        mv android/app/build/outputs/apk/release/app-release-unsigned.apk android/app/build/outputs/apk/release/Os-Sete-Livramentos.apk
      
    - name: Upload Debug APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: Os-Sete-Livramentos-debug
        path: android/app/build/outputs/apk/debug/Os-Sete-Livramentos-debug.apk
        retention-days: 30

    - name: Upload Release APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: Os-Sete-Livramentos
        path: android/app/build/outputs/apk/release/Os-Sete-Livramentos.apk
        retention-days: 30

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT

    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.date.outputs.date }}
        name: Toque Os Sete Livramentos v${{ steps.date.outputs.date }}
        body: |
          ## ðŸ“± Toque de Celular - Os Sete Livramentos
          
          Baixe o APK e instale no seu celular Android!
          
          ### Como instalar:
          1. Baixe o arquivo **Os-Sete-Livramentos.apk** abaixo
          2. Abra o arquivo no celular
          3. Permita a instalaÃ§Ã£o de fontes desconhecidas (se solicitado)
          4. Abra o app e toque em "Definir toque automaticamente"
          
          ### Arquivos:
          - **Os-Sete-Livramentos.apk** - App para instalar (recomendado)
          - **Os-Sete-Livramentos-debug.apk** - VersÃ£o de teste
          
          ---
          ðŸŽµ Acesse tambÃ©m: https://toque-gospel-facil.lovable.app/
        files: |
          android/app/build/outputs/apk/release/Os-Sete-Livramentos.apk
          android/app/build/outputs/apk/debug/Os-Sete-Livramentos-debug.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
